<%
    import re

    # Convert underscore to camelCase
    under_pat = re.compile(r'_([a-z])')
    def underscore_to_camel(text):
        return under_pat.sub(lambda x: x.group(1).upper(), text)

    def get_singular(name, capitalize = True):
        retval = name
        if (name[len(name)-1] == 's'):
            retval = name[0:len(name)-1]
        if (capitalize):
            retval = retval.capitalize();
        return retval

%><?php
/**
 * Models from schema: ${ model['schema-name'] } version ${ model['version'] }
 * Code generated by ${params['TASK_TYPE_NAME']}
 *
 */


% for entity_name, entity_def in model['entities'].iteritems():
/**
 * Add following line in app/routes.php
 * Route::resource('${entity_name}', '${get_singular(entity_name, True)}Controller');
 */
class ${get_singular(entity_name, True)}Controller extends \BaseController {

	protected $layout = 'layouts.master';

	/**
	 * Display a listing of the resource.
	 *
	 * @return Response
	 */
	public function index()
	{
		$records = ${get_singular(entity_name, True)}::all();
		$this->layout->content = View::make('${entity_name}.index')
		    ->with('records', $records);
	}

	/**
	 * Show the form for creating a new resource.
	 *
	 * @return Response
	 */
	public function create()
	{
		$this->layout->content = View::make('${entity_name}.create');
	}

	/**
	 * Store a newly created resource in storage.
	 *
	 * @return Response
	 */
	public function store()
	{
		$data = Input::all();

		$validator = ${get_singular(entity_name, True)}::validator($data);
        if ($validator->passes()) {
            $record = new User();
            $record->fill($data);

            /*
             * @todo: assign default values as needed
             */
            $now = new DateTime;
            $now_str = $now->format('Y-m-d H:i:s');
            $record->uuid = uniqid();
            $record->created_dt = $now_str;
            $record->updated_dt = $now_str;
            */
            $record->save();

            // @todo: Redirect to proper URL
            Session::flash('message', 'Successfully updated!');
            return Redirect::to('${entity_name}');
        } else {
            // Redirecting to same form
            return Redirect::to('${entity_name}/create')
                ->withErrors($validator);
                // Uncomment following line if applicable
                //->withInput(Input::except('password'));
        }
	}

	/**
	 * Display the specified resource.
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function show($id)
	{
		$record = ${get_singular(entity_name, True)}::find($id);

		// show the view and pass the nerd to it
		$this->layout->content = View::make('${entity_name}.show')
			->with('record', $record);
	}

	/**
	 * Show the form for editing the specified resource.
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function edit($id)
	{
	    $record = ${get_singular(entity_name, True)}::find($id);

		$this->layout->content = View::make('${entity_name}.edit')
		    ->with('record', $record);
	}

	/**
	 * Update the specified resource in storage.
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function update($id)
	{
	    // @todo: Validate input

		$data = Input::all();
		$validator = ${get_singular(entity_name, True)}::validator($data);
        if ($validator->passes()) {
            $record = ${get_singular(entity_name, True)}::find($id);
            $record->fill($data);
            $record->save();

            // @todo: Redirect to proper URL
            Session::flash('message', 'Successfully updated!');
            return Redirect::to('${entity_name}');
        } else {
            return Redirect::to('${entity_name}/' . $id . '/edit')
                ->withErrors($validator)
                ->withInput(Input::except('password'));
        }
	}

	/**
	 * Remove the specified resource from storage.
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function destroy($id)
	{
		// delete
		$record = ${get_singular(entity_name, True)}::find($id);
		$record->delete();

		// redirect
		Session::flash('message', 'Successfully deleted!');
		return Redirect::to('${entity_name}');
	}
}
% endfor
